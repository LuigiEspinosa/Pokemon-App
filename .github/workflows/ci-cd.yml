name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPO_BACKEND: pokemon-backend
  ECR_REPO_FRONTEND: pokemon-frontend

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Install Node.js and pnpm
      - name: Set up Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install pnpm
        run: npm install -g pnpm

      # Install dependencies and build the backend
      - name: Backend build
        working-directory: apps/backend
        run: |
          pnpm install --frozen-lockfile
          pnpm run build

      # Install dependencies and build the frontend
      - name: Frontend build
        working-directory: apps/frontend
        run: |
          pnpm install --frozen-lockfile
          pnpm run build

  deploy:
    needs: build-test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      # --- AWS auth (OIDC) ---
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      # --- Push images to ECR ---
      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & push backend image
        run: |
          docker build -t $ECR_REPO_BACKEND:latest apps/backend
          docker tag  $ECR_REPO_BACKEND:latest ${{ steps.ecr.outputs.registry }}/$ECR_REPO_BACKEND:latest
          docker push ${{ steps.ecr.outputs.registry }}/$ECR_REPO_BACKEND:latest

      - name: Build & push frontend image
        run: |
          docker build -t $ECR_REPO_FRONTEND:latest apps/frontend
          docker tag  $ECR_REPO_FRONTEND:latest ${{ steps.ecr.outputs.registry }}/$ECR_REPO_FRONTEND:latest
          docker push ${{ steps.ecr.outputs.registry }}/$ECR_REPO_FRONTEND:latest

      # --- Install Terraform (fixes "terraform: command not found") ---
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      # --- Provide tfvars from secrets (skip if you commit terraform.tfvars) ---
      - name: Write terraform.tfvars
        working-directory: infra/terraform
        run: |
          cat > terraform.tfvars << 'EOF'
          region                 = "${{ env.AWS_REGION }}"
          account_id             = "${{ secrets.AWS_ACCOUNT_ID }}"
          ecr_repo_frontend      = "${{ env.ECR_REPO_FRONTEND }}"
          ecr_repo_backend       = "${{ env.ECR_REPO_BACKEND }}"
          route53_zone_id        = "${{ secrets.ROUTE53_ZONE_ID }}"
          ecs_task_execution_role= "${{ secrets.ECS_TASK_EXEC_ROLE_ARN }}"
          EOF

      # --- Terraform ---
      - name: Terraform Init
        working-directory: infra/terraform
        run: terraform init -input=false

      - name: Auto-import existing ALB/TGs into Terraform state (idempotent)
        working-directory: infra/terraform
        shell: bash
        run: |
          set -euo pipefail

          # Detect existing ALB by name
          LB_NAME="pokemon-alb"
          TG_FRONT_NAME="tg-frontend"
          TG_BACK_NAME="tg-backend"

          LB_ARN=$(aws elbv2 describe-load-balancers --names "$LB_NAME" \
            --query 'LoadBalancers[0].LoadBalancerArn' --output text 2>/dev/null || true)
          if [[ -n "$LB_ARN" && "$LB_ARN" != "None" ]]; then
            echo "Found existing ALB: $LB_ARN"
            terraform import -no-color aws_lb.app "$LB_ARN" || true
          else
            echo "No pre-existing ALB found."
          fi

          TGF_ARN=$(aws elbv2 describe-target-groups --names "$TG_FRONT_NAME" \
            --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null || true)
          if [[ -n "$TGF_ARN" && "$TGF_ARN" != "None" ]]; then
            echo "Found existing frontend TG: $TGF_ARN"
            terraform import -no-color aws_lb_target_group.frontend "$TGF_ARN" || true
          else
            echo "No pre-existing frontend TG found."
          fi

          TGB_ARN=$(aws elbv2 describe-target-groups --names "$TG_BACK_NAME" \
            --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null || true)
          if [[ -n "$TGB_ARN" && "$TGB_ARN" != "None" ]]; then
            echo "Found existing backend TG: $TGB_ARN"
            terraform import -no-color aws_lb_target_group.backend "$TGB_ARN" || true
          else
            echo "No pre-existing backend TG found."
          fi

      - name: Auto-import preexisting ECS services & Route53 A-records
        working-directory: infra/terraform
        shell: bash
        run: |
          set -euo pipefail

          ZONE_ID="${{ secrets.ROUTE53_ZONE_ID }}"
          CLUSTER="pokemon-ecs"
          SVC_FE="pokemon-frontend"
          SVC_BE="pokemon-backend"
          APEX="pokemon.cuatro.dev"
          APIH="api.pokemon.cuatro.dev"

          echo ">>> Import ECS services if they already exist"
          # Describe returns "servicesNotFound" if missing; we suppress errors and check ARN
          FE_ARN=$(aws ecs describe-services --cluster "$CLUSTER" --services "$SVC_FE" \
            --query 'services[0].serviceArn' --output text 2>/dev/null || true)
          if [[ -n "$FE_ARN" && "$FE_ARN" != "None" ]]; then
            echo "Importing ECS service (frontend): $FE_ARN"
            terraform import -no-color aws_ecs_service.frontend "$FE_ARN" || true
          else
            echo "No preexisting frontend ECS service"
          fi

          BE_ARN=$(aws ecs describe-services --cluster "$CLUSTER" --services "$SVC_BE" \
            --query 'services[0].serviceArn' --output text 2>/dev/null || true)
          if [[ -n "$BE_ARN" && "$BE_ARN" != "None" ]]; then
            echo "Importing ECS service (backend): $BE_ARN"
            terraform import -no-color aws_ecs_service.backend "$BE_ARN" || true
          else
            echo "No preexisting backend ECS service"
          fi

          echo ">>> Import Route53 A/ALIAS records if they already exist"
          # R53 import ID format: <zone_id>_<record_name>_<type>
          # Use names WITHOUT trailing dot
          APEX_EXISTS=$(aws route53 list-resource-record-sets --hosted-zone-id "$ZONE_ID" \
            --query "ResourceRecordSets[?Name=='${APEX}.'].Type" --output text || true)
          if [[ "$APEX_EXISTS" == *"A"* ]]; then
            echo "Importing A record: ${APEX}"
            terraform import -no-color aws_route53_record.frontend_a "${ZONE_ID}_${APEX}_A" || true
          else
            echo "No preexisting A record for ${APEX}"
          fi

          API_EXISTS=$(aws route53 list-resource-record-sets --hosted-zone-id "$ZONE_ID" \
            --query "ResourceRecordSets[?Name=='${APIH}.'].Type" --output text || true)
          if [[ "$API_EXISTS" == *"A"* ]]; then
            echo "Importing A record: ${APIH}"
            terraform import -no-color aws_route53_record.backend_a "${ZONE_ID}_${APIH}_A" || true
          else
            echo "No preexisting A record for ${APIH}"
          fi

      - name: Terraform Plan
        working-directory: infra/terraform
        run: terraform plan -input=false

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        working-directory: infra/terraform
        run: terraform apply -auto-approve -input=false
